<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Places Finder</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.5/dist/bootstrap-table.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script
      th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${googleApiKey} + '&libraries=places'"
    ></script>
    <style>
      #map {
        height: 500px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mt-5">Find Places</h1>
      <div class="alert alert-info">
        Georgia Tech's latitude & longitude are: 33.7709454, -84.3942562.
      </div>
      <form method="GET" action="/" class="mt-3 mb-3">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="latitude" class="form-label">Latitude</label>
            <input
              type="text"
              class="form-control"
              id="latitude"
              name="latitude"
              th:value="${latitude}"
              required
            />
          </div>
          <div class="col-md-3">
            <label for="longitude" class="form-label">Longitude</label>
            <input
              type="text"
              class="form-control"
              id="longitude"
              name="longitude"
              th:value="${longitude}"
              required
            />
          </div>
          <div class="col-md-3">
            <label for="radius" class="form-label">Radius (in meters)</label>
            <input
              type="text"
              class="form-control"
              id="radius"
              name="radius"
              th:value="${radius}"
              required
            />
          </div>
          <div class="col-md-3">
            <label for="locationType" class="form-label">Location Type</label>
            <select
              multiple
              class="form-select"
              id="locationTypes"
              name="locationTypes"
              th:value="${locationTypes}"
            >
              <option
                value="bar"
                th:selected="${locationTypes.contains('bar')}"
              >
                Bar
              </option>
              <option
                value="meal_delivery"
                th:selected="${locationTypes.contains('meal_delivery')}"
              >
                Meal Delivery
              </option>
              <option
                value="meal_takeaway"
                th:selected="${locationTypes.contains('meal_takeaway')}"
              >
                Meal Takeaway
              </option>
              <option
                value="cafe"
                th:selected="${locationTypes.contains('cafe')}"
              >
                Cafe
              </option>
              <option
                value="restaurant"
                th:selected="${locationTypes.contains('restaurant')}"
              >
                Restaurant
              </option>
              <option
                value="food"
                th:selected="${locationTypes.contains('food')}"
              >
                Food
              </option>
              <option
                value="point_of_interest"
                th:selected="${locationTypes.contains('point_of_interest')}"
              >
                Point of Interest
              </option>
              <option
                value="establishment"
                th:selected="${locationTypes.contains('establishment')}"
              >
                Establishment
              </option>
            </select>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-12">
            <button type="submit" class="btn btn-primary">Search</button>
          </div>
        </div>
      </form>

      <div id="map"></div>
      <table id="places-table" class="table table-striped">
        <thead>
          <tr>
            <th>Name</th>
            <th>Address</th>
            <th>Tags</th>
          </tr>
        </thead>
        <tbody id="places-table-body"></tbody>
      </table>
    </div>

    <script>
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        let regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        let results = regex.exec(location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      function initMap() {
        // Default latitude and longitude are set for Georgia Tech
        let latitude = parseFloat(getUrlParameter("latitude")) || 33.7709454;
        let longitude = parseFloat(getUrlParameter("longitude")) || -84.3942562;
        let types = getUrlParameter("locationType") || "restaurant";
        const latLong = { lat: latitude, lng: longitude };

        const map = new google.maps.Map($("#map")[0], {
          center: latLong,
          zoom: 15,
        });

        const service = new google.maps.places.PlacesService(map);

        const request = {
          location: latLong,
          radius: parseFloat(getUrlParameter("radius")) || 500, // Radius in meters
          type: [types], // can be multiple types
        };

        const specialMarker = new google.maps.Marker({
          map: map,
          position: latLong,
          icon: {
            url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
          },
          draggable: true,
        });

        // Perform the search and process the results
        service.nearbySearch(request, function (results, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            for (let i = 0; i < results.length; i++) {
              createMarker(results[i]);
              addPlaceToList(results[i]);
            }
            $("#places-table").bootstrapTable({
              sortable: true,
              columns: [
                {
                  field: "name",
                  title: "Name",
                  sortable: true,
                },
                {
                  field: "address",
                  title: "Address",
                  sortable: true,
                },
                {
                  field: "tags",
                  title: "Tags",
                },
              ],
              data: tableData,
            });
          }
        });

        function createMarker(place) {
          const contentString = `
            <div>
              <h4>${place.name}</h3>
              <p>${place.vicinity}</p>
              <p>Price Level: ${place.price_level}</p>
            </div>
          `;
          const infowindow = new google.maps.InfoWindow({
            content: contentString,
            ariaLabel: place.name,
          });

          const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,

            title: place.name, // On hover, the place name is shown.
          });
          marker.addListener("click", () => {
            infowindow.open({
              anchor: marker,
              map,
            });
          });
        }

        const tableData = [];

        function addPlaceToList(place) {
          // A place returned from the API will have the following useful attributes (and more):
          // place.name: Name of the place
          // place.vicinity: Address of the place
          // place.types: array of tags
          // place.opening_hours: Opening hours
          tableData.push({
            name: place.name,
            address: place.vicinity,
            tags: place.types.join(", "),
          });
        }
      }

      window.onload = initMap;
    </script>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.5/dist/bootstrap-table.min.js"></script>
  </body>
</html>
