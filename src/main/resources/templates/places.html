<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Places Finder</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.5/dist/bootstrap-table.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script
      th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${googleApiKey} + '&libraries=places,geometry'"
    ></script>
    <style>
      #map {
        height: 500px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container d-flex justify-content-between align-items-center mt-4 mb-4">
      <h1 class="mb-0">LocationSearch</h1>
      <form method="POST" action="/logout">
        <button type="submit" class="btn btn-danger">Logout</button>
      </form>
    </div>
    <div class="container">
      <div class="alert alert-info">
        Default search is centered on Georgia Tech (latitude: 33.7709454, longitude: -84.3942562).
      </div>
      <form method="GET" action="/" class="mt-3 mb-3">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="latitude" class="form-label">Latitude</label>
            <input
              type="text"
              class="form-control"
              id="latitude"
              name="latitude"
              th:value="${latitude}"
              required
            />
          </div>
          <div class="col-md-3">
            <label for="longitude" class="form-label">Longitude</label>
            <input
              type="text"
              class="form-control"
              id="longitude"
              name="longitude"
              th:value="${longitude}"
              required
            />
          </div>
          <div class="col-md-3">
            <label for="radius" class="form-label">Radius (in meters)</label>
            <input
              type="text"
              class="form-control"
              id="radius"
              name="radius"
              th:value="${radius}"
              required
            />
          </div>
          <div class="col-md-3">
            <label for="locationType" class="form-label">Location Type</label>
            <select
              multiple
              class="form-select"
              id="locationTypes"
              name="locationTypes"
            >
              <option
                value="bar"
                th:selected="${locationTypes.contains('bar')}"
              >
                Bar
              </option>
              <option
                value="meal_delivery"
                th:selected="${locationTypes.contains('meal_delivery')}"
              >
                Meal Delivery
              </option>
              <option
                value="meal_takeaway"
                th:selected="${locationTypes.contains('meal_takeaway')}"
              >
                Meal Takeaway
              </option>
              <option
                value="cafe"
                th:selected="${locationTypes.contains('cafe')}"
              >
                Cafe
              </option>
              <option
                value="restaurant"
                th:selected="${locationTypes.contains('restaurant')}"
              >
                Restaurant
              </option>
              <option
                value="food"
                th:selected="${locationTypes.contains('food')}"
              >
                Food
              </option>
              <option
                value="point_of_interest"
                th:selected="${locationTypes.contains('point_of_interest')}"
              >
                Point of Interest
              </option>
              <option
                value="establishment"
                th:selected="${locationTypes.contains('establishment')}"
              >
                Establishment
              </option>
            </select>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-3">
            <label for="limit" class="form-label">Number of locations to display</label>
            <input type="number" class="form-control" id="limit" name="limit" min="1" max="20" th:value="${limit}" required>
          </div>
          <div class="col-md-9 d-flex align-items-end">
            <button type="submit" class="btn btn-primary">Search</button>
          </div>
        </div>
      </form>

      <div id="map"></div>
      <table id="places-table" class="table table-striped">
        <thead>
          <tr>
            <th data-field="name" data-sortable="true">Name</th>
            <th data-field="address" data-sortable="true">Address</th>
            <th data-field="tags" data-sortable="true">Tags</th>
            <th data-field="distance" data-sortable="true">Distance (m)</th>
            <th data-field="rating" data-sortable="true">Rating</th>
            <th data-field="openingHours" data-sortable="true">Opening Hours</th>
            <th data-field="priceLevel" data-sortable="true">Price Level</th>
          </tr>
        </thead>
        <tbody id="places-table-body"></tbody>
      </table>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      const defaultLatitude = /*[[${latitude}]]*/ '33.7709454';
      const defaultLongitude = /*[[${longitude}]]*/ '-84.3942562';
      const defaultRadius = /*[[${radius}]]*/ '500';
      const defaultLimit = /*[[${limit}]]*/ 10;
      const defaultLocationTypes = /*[[${locationTypes}]]*/ ['restaurant'];
      /*]]>*/

      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        let regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        let results = regex.exec(location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      function initMap() {

        let latitude = parseFloat(getUrlParameter("latitude")) || parseFloat(defaultLatitude);
        let longitude = parseFloat(getUrlParameter("longitude")) || parseFloat(defaultLongitude);
        let radius = parseFloat(getUrlParameter("radius")) || parseFloat(defaultRadius);
        let limit = parseInt(getUrlParameter("limit")) || defaultLimit;
        let types = getUrlParameter("locationTypes") || defaultLocationTypes.join(',');
        
        const latLong = { lat: latitude, lng: longitude };

        const map = new google.maps.Map($("#map")[0], {
          center: latLong,
          zoom: 15,
        });

        const service = new google.maps.places.PlacesService(map);

        const request = {
          location: latLong,

          radius: radius,

          type: types.split(','),
        };

        const specialMarker = new google.maps.Marker({
          map: map,
          position: latLong,
          icon: {
            url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
          },
          draggable: true,
        });

        service.nearbySearch(request, function (results, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {

            results = results.slice(0, limit);            
            for (let i = 0; i < results.length; i++) {
              createMarker(results[i], map, latLong);

              getPlaceDetails(results[i], i === results.length - 1);
            }
          }
        });

        function createMarker(place, map, centerLatLng) {
          const distance = google.maps.geometry.spherical.computeDistanceBetween(
            centerLatLng,
            place.geometry.location
          );

          const contentString = `
            <div>

              <h5>${place.name}</h5>
              <p>Distance: ${Math.round(distance)} m</p>
              <p>Rating: ${place.rating ? place.rating + ' / 5' : 'N/A'}</p>
              <p>Price Level: ${getPriceLevel(place.price_level)}</p>

            </div>
          `;

          const infowindow = new google.maps.InfoWindow({
            content: contentString,
            ariaLabel: place.name,
          });

          const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            title: place.name,

          });

          marker.addListener("mouseover", () => {
            infowindow.open({
              anchor: marker,
              map,
            });
          });

          marker.addListener("mouseout", () => {
            infowindow.close();

          });

          marker.addListener("click", () => {
            infowindow.open({
              anchor: marker,
              map,
            });
          });
        }

        function getPriceLevel(level) {
          if (level === undefined) return 'N/A';
          return '$'.repeat(level);
        }

        const tableData = [];

        function getPlaceDetails(place, isLast) {
          service.getDetails({ placeId: place.place_id }, function(result, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              addPlaceToList(result);
              if (isLast) {
                initTable();
              }
            }
          });
        }

        function addPlaceToList(place) {
          const distance = google.maps.geometry.spherical.computeDistanceBetween(
            new google.maps.LatLng(latitude, longitude),
            place.geometry.location
          );

          tableData.push({
            name: place.name,
            address: place.vicinity,
            tags: place.types.join(", "),
            distance: Math.round(distance),
            rating: place.rating || "N/A",
            openingHours: place.opening_hours ? (place.opening_hours.isOpen() ? "Open" : "Closed") : "N/A",

            priceLevel: getPriceLevel(place.price_level)

          });
        }

        function initTable() {
          $("#places-table").bootstrapTable({
            data: tableData,
            sortName: 'distance',
            sortOrder: 'asc'
          });
        }
      }

      window.onload = initMap;
    </script>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.5/dist/bootstrap-table.min.js"></script>
  </body>
</html>